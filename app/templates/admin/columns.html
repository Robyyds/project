{% extends "base.html" %}
{% block title %}列管理{% endblock %}
{% block content %}
<div class="container-fluid">
    <h4 class="mb-3">动态列管理</h4>
    <form method="POST" action="{{ url_for('admin.add_column') }}" class="row g-2 mb-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="col-auto"><input class="form-control" name="name" placeholder="列名称" required></div>
        <div class="col-auto">
            <select class="form-select" name="data_type">
                <option value="string">字符串</option>
                <option value="integer">整数</option>
                <option value="date">日期</option>
                <option value="boolean">布尔</option>
            </select>
        </div>
        <div class="col-auto"><button class="btn btn-primary" type="submit">添加</button></div>
    </form>

    <table class="table table-hover">
        <thead><tr><th>ID</th><th>列名</th><th>数据类型</th><th>状态</th><th>创建时间</th><th>操作</th></tr></thead>
        <tbody>
            {% for column in columns %}
            <tr>
                <td>{{ column.id }}</td>
                <td>{{ column.name }}</td>
                <td>{{ column.data_type }}</td>
                <td>{{ '启用' if column.is_active else '禁用' }}</td>
                <td>{{ column.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger delete-col"
                            data-url="{{ url_for('admin.delete_column_item', column_id=column.id) }}">删除</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
const csrfToken = document.querySelector('input[name="csrf_token"]').value;
document.querySelectorAll('.delete-col').forEach(btn => {
    btn.addEventListener('click', async () => {
        if (!confirm('确定删除此列？')) return;
        const res = await fetch(btn.dataset.url, {method:'POST', headers:{'X-CSRFToken':csrfToken}});
        if (res.ok) location.reload();
        else alert('删除失败');
    });
});
</script>
{% endblock %}